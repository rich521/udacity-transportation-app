"use strict";"strict";var angular,moment,IDBStore,$;angular.module("trainApp",["ui.bootstrap"]).controller("MainController",["$scope",function(t){function e(t){var e=t.date,o=t.mode;if("day"===o)for(var n=new Date(e).setHours(0,0,0,0),r=0;r<l.events.length;r++){var a=new Date(l.events[r].date).setHours(0,0,0,0);if(n===a)return l.events[r].status}return""}function o(t){var e=r(),o=moment(l.mytime).format("HH:mm:ss"),a=l.radioModel;if(!e)return $(".help-tool-4").show(),!1;if($(".help-tool-4").hide(),!t)switch(e){case 0:n(3,a,o);break;case 6:n(1,a,o);break;default:n(0,a,o)}if(t)switch(e){case 0:n(7,a,o);break;case 6:n(5,a,o);break;default:n(4,a,o)}}function n(t,e,o){var n=d.substring(d.length-7),r=p.substring(p.length-7),a=i[t].vehicleJourneys.ServiceJourney,s=[0,0],u=!1;t:for(var y=0;y<a.length;y++){var b=a[y].calls.Call;s=[0,0];for(var g=0;g<b.length;g++){var w=b[g],D=w.ScheduledStopPointRef.ref,H=w.Departure.Time,S=moment.utc(moment(H,"HH:mm:ss").diff(moment(o,"HH:mm:ss"))).format("HH:mm:ss").substring(0,2);if(e||(D===n&&1.5>S&&(s[0]=1,m=H),D===r&&(f=H,s[1]=1)),e&&D===r&&(1.5>S&&(s[1]=1,f=H),D===n&&(m=H,s[1]=1)),s[0]&&s[1]){$(".noTrains").hide(),$(".tableTimes").show(),l.myValue=!0;var T=moment.utc(moment(f,"HH:mm:ss").diff(moment(m,"HH:mm:ss"))).format("HH:mm:ss").substring(0,5),k=T.substring(0,2),M=T.substring(3,5);u=!0,l.trainTimes={Departure:m.slice(0,-3),From:d,Arrival:f.slice(0,-3),To:p,Duration:k+" hr "+M+" min",Stops:{numStops:Math.abs(c-h),listStops:v}},window.scrollTo(0,document.body.scrollHeight);break t}}}u||($(".noTrains").show(),$(".tableTimes").hide(),window.scrollTo(0,document.body.scrollHeight))}function r(){var t=$("#when").val(),e="Do MMMM yyyy",o=moment(t,e),n=o.day();return!!moment(o,e,!0).isValid()&&n}var a,i,s,l=t,u=["http://api.511.org/transit/stops?api_key=a9a92f72-6f26-4d58-a1ab-db8ab5833ed2&operator_id=Capitol Corridor&format=Json","http://api.511.org/transit/timetable?api_key=a9a92f72-6f26-4d58-a1ab-db8ab5833ed2&operator_id=Capitol Corridor&line_id=CAPITOL&format=Json"];new Promise(function(t){s=new IDBStore({dbVersion:1,storeName:"trainTimes",keyPath:"id",onStoreReady:function(){var e=function(e){e&&(a=e.sto,i=e.stt,l.stations=a),t()},o=function(e){$(".help-tool-5").show(),console.log(e),t()};s.get(1,e,o)}})}).then(function(){Promise.all(u.map(function(t){return fetch(t)})).then(function(t){return Promise.all(t.map(function(t){return t.json()}))}).then(function(t){for(var e=[],o=t[0].Contents.dataObjects.ScheduledStopPoint,n=0;n<o.length;n++){var r=o[n];e.push(r.Name+" - "+r.id)}a=[e[11],e[1],e[7],e[2],e[3],e[0],e[6],e[5],e[4],e[9],e[10],e[8]],i=t[1].Content.TimetableFrame,l.stations=a;var u={id:1,sto:a,stt:i},m=function(t){console.log("successful update: "+t)},f=function(t){console.log(t)};s.put(u,m,f)}).catch(function(t){$(".help-tool-5").show(),console.log(t)})}),l.radioModel=0,l.today=function(){l.dt=new Date},l.today(),l.clear=function(){l.dt=null},l.inlineOptions={customClass:e,minDate:new Date,showWeeks:!1},l.dateOptions={formatYear:"yy",minDate:new Date,startingDay:1,showWeeks:!1},l.open1=function(){l.popup1.opened=!0},l.open2=function(){l.popup2.opened=!0},l.setDate=function(t,e,o){l.dt=new Date(t,e,o)},l.format="dd MMMM yyyy",l.altInputFormats=["M!/d!/yyyy"],l.popup1={opened:!1},l.popup2={opened:!1},l.myValue=!1,l.mytime=new Date,l.hstep=1,l.mstep=5,l.ismeridian=!1;var m,f,d,p,c,h,v=[];l.trainTimes={Departure:"-",From:"-",To:"-",Arrival:"-",Duration:"-",Stops:{numStops:"-",listStops:"-"}},l.check=function(){function t(t,e,o){v=[];for(var n=t;n<e;n++)v.push(a[n].slice(0,-10));o||v.reverse()}if(d=$("#station_1").val(),p=$("#station_2").val(),!d)return $(".help-tool-1").show(),!1;if(!p)return $(".help-tool-2").show(),$(".help-tool-3").hide(),!1;if(d===p)return $(".help-tool-3").show(),!1;if("undefined"!=typeof d&&"undefined"!=typeof p)for(var e=1;e<4;e++){var n=".help-tool-"+e;$(n).hide()}for(var r=0;r<a.length;r++)if(d===a[r]){c=r;break}for(var i=0;i<a.length;i++)if(p===a[i]){h=i;break}c<h&&(t(c+1,h+1),1,o(1)),c>h&&(t(h,c,0),o(0))}}]);